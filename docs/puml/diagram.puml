@startuml ImprovedToolchain
title Reflect-C Toolchain Flow

actor Developer

node "Authoring" {
    component "Recipe Headers\n(.PRE.h)" as Recipes
}

node "Build Helpers" {
    component "reflect-c.mk"
    component "reflect-c_EXPAND_COMMENTS" as Expand
    component "reflect-c_RECIPES.PRE.h\n(roles)" as RecipesPre
}

node "Compilation" {
    component "C Preprocessor\n+ Compiler" as CPP
}

node "Outputs" {
    component "reflect-c_GENERATED.h/.c" as Generated
    component "libreflectc.a\n(optional)" as StaticLib
}

node "Runtime" {
    component "reflect-c.c/.h" as RuntimeLibrary
}

Developer --> Recipes : Write recipes
Developer --> "reflect-c.mk" : Run 'make gen'

"reflect-c.mk" --> Recipes : Collect
"reflect-c.mk" --> Expand : Expand directives
Expand --> RecipesPre : Emit role sources
RecipesPre --> CPP : Replay with REFLECTC_* flags
CPP --> Generated : Produce metadata

"reflect-c.mk" --> StaticLib : Archive runtime (optional)
Runtime --> StaticLib
Runtime --> Generated : Linked at use-site

note right of Generated
Constructors, enums,
metadata tables.
end note
@enduml
